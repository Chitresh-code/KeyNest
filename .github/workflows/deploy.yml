name: EC2

on:
  push:
    branches: [ main ]
    paths:
      - 'backend/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch: # Allow manual trigger

env:
  EC2_HOST: 13.203.105.44
  EC2_USER: ubuntu
  DEPLOY_PATH: /home/ubuntu/KeyNest

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup SSH key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_PRIVATE_KEY }}" > ~/.ssh/keynest-prod-key.pem
        chmod 600 ~/.ssh/keynest-prod-key.pem
        
        # Configure SSH to skip host key verification for CI/CD
        cat >> ~/.ssh/config << EOF
        Host $EC2_HOST
          HostName $EC2_HOST
          User $EC2_USER
          IdentityFile ~/.ssh/keynest-prod-key.pem
          StrictHostKeyChecking no
          UserKnownHostsFile /dev/null
        EOF

    - name: Test SSH connection
      run: |
        echo "Testing SSH connection to $EC2_HOST..."
        ssh -o ConnectTimeout=30 $EC2_HOST "echo 'SSH connection successful'"

    - name: Deploy application
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
      run: |
        ssh -o SendEnv=DATABASE_URL $EC2_HOST "DATABASE_URL=$DATABASE_URL /home/ubuntu/KeyNest/backend/scripts/deploy.sh"
        set -e
        
        echo "ğŸš€ Starting deployment..."
        
        # Ensure git is installed
        sudo apt-get update -qq && sudo apt-get install -y git
        
        # Check if repository exists, clone if not
        if [ ! -d "/home/ubuntu/KeyNest" ]; then
          echo "ğŸ“¥ Repository not found, cloning..."
          cd /home/ubuntu
          git clone https://github.com/Chitresh-code/KeyNest.git KeyNest
          cd KeyNest
          echo "âœ… Repository cloned successfully"
        else
          echo "ğŸ“‚ Repository exists, updating..."
          cd /home/ubuntu/KeyNest
          # Ensure it's a valid git repository
          if [ ! -d ".git" ]; then
            echo "ğŸ”„ Invalid git repository, re-cloning..."
            cd /home/ubuntu
            sudo rm -rf KeyNest
            git clone https://github.com/Chitresh-code/KeyNest.git KeyNest
            cd KeyNest
          else
            # Pull latest changes
            git fetch origin
            git reset --hard origin/main
            git clean -fd
          fi
        fi
        
        # Make sure deploy script is executable
        chmod +x /home/ubuntu/KeyNest/backend/scripts/deploy.sh
        
        # Set DATABASE_URL environment variable for deployment
        export DATABASE_URL="$DATABASE_URL"
        
        # Run the deployment using docker-compose
        cd /home/ubuntu/KeyNest/backend
        docker-compose down --volumes --remove-orphans 2>/dev/null || true
        docker-compose pull
        docker-compose up -d --build
        
        # Wait for services to be ready
        sleep 30
        
        # Run database migrations
        docker-compose exec -T api python manage.py makemigrations --noinput
        docker-compose exec -T api python manage.py migrate --noinput
        docker-compose exec -T api python manage.py collectstatic --noinput
        
        echo "âœ… Deployment workflow completed!"
        DEPLOY_SCRIPT

    - name: Verify deployment
      run: |
        echo "ğŸ” Verifying deployment..."
        echo "âœ… Deployment completed successfully! Services are running on EC2."
        echo "ğŸŒ API available at: http://$EC2_HOST:8001/api/"
        echo "Note: External access requires security group configuration for port 8001"

    - name: Cleanup SSH key
      if: always()
      run: |
        rm -f ~/.ssh/keynest-prod-key.pem

    - name: Notify deployment status
      if: always()
      run: |
        if [ "${{ job.status }}" = "success" ]; then
          echo "ğŸ‰ Deployment to EC2 ($EC2_HOST) completed successfully!"
          echo "ğŸŒ API available at: http://$EC2_HOST:8001/api/"
        else
          echo "ğŸ’¥ Deployment failed! Check the logs above for details."
        fi