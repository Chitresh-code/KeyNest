name: Deploy KeyNest Backend to EC2

on:
  push:
    branches: [ main ]
    paths:
      - 'backend/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch: # Allow manual trigger

env:
  EC2_HOST: 13.203.105.44
  EC2_USER: ubuntu
  DEPLOY_PATH: /home/ubuntu/KeyNest

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup SSH key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_PRIVATE_KEY }}" > ~/.ssh/keynest-prod-key.pem
        chmod 600 ~/.ssh/keynest-prod-key.pem
        ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts

    - name: Test SSH connection
      run: |
        ssh -i ~/.ssh/keynest-prod-key.pem -o ConnectTimeout=10 $EC2_USER@$EC2_HOST "echo 'SSH connection successful'"

    - name: Deploy application
      run: |
        ssh -i ~/.ssh/keynest-prod-key.pem $EC2_USER@$EC2_HOST << 'DEPLOY_SCRIPT'
        set -e
        
        echo "ðŸš€ Starting deployment..."
        
        # Navigate to project directory and pull latest changes
        cd /home/ubuntu/KeyNest
        git fetch origin
        git reset --hard origin/main
        git clean -fd
        
        # Make sure deploy script is executable
        chmod +x /home/ubuntu/KeyNest/backend/scripts/deploy.sh
        
        # Run the deployment script
        /home/ubuntu/KeyNest/backend/scripts/deploy.sh
        
        echo "âœ… Deployment workflow completed!"
        DEPLOY_SCRIPT

    - name: Verify deployment
      run: |
        echo "ðŸ” Verifying deployment..."
        response=$(curl -s -o /dev/null -w "%{http_code}" http://$EC2_HOST:8001/api/ || echo "000")
        if [ "$response" = "200" ]; then
          echo "âœ… Deployment verification successful!"
        else
          echo "âŒ Deployment verification failed! HTTP status: $response"
          exit 1
        fi

    - name: Cleanup SSH key
      if: always()
      run: |
        rm -f ~/.ssh/keynest-prod-key.pem

    - name: Notify deployment status
      if: always()
      run: |
        if [ "${{ job.status }}" = "success" ]; then
          echo "ðŸŽ‰ Deployment to EC2 ($EC2_HOST) completed successfully!"
          echo "ðŸŒ API available at: http://$EC2_HOST:8001/api/"
        else
          echo "ðŸ’¥ Deployment failed! Check the logs above for details."
        fi