name: Deploy KeyNest Backend to EC2

on:
  push:
    branches: [ main ]
    paths:
      - 'backend/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch: # Allow manual trigger

env:
  EC2_HOST: 13.203.105.44
  EC2_USER: ubuntu
  DEPLOY_PATH: /home/ubuntu/KeyNest

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup SSH key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_PRIVATE_KEY }}" > ~/.ssh/keynest-prod-key.pem
        chmod 600 ~/.ssh/keynest-prod-key.pem
        
        # Configure SSH to skip host key verification for CI/CD
        cat >> ~/.ssh/config << EOF
        Host $EC2_HOST
          HostName $EC2_HOST
          User $EC2_USER
          IdentityFile ~/.ssh/keynest-prod-key.pem
          StrictHostKeyChecking no
          UserKnownHostsFile /dev/null
        EOF

    - name: Test SSH connection
      run: |
        echo "Testing SSH connection to $EC2_HOST..."
        ssh -o ConnectTimeout=30 $EC2_HOST "echo 'SSH connection successful'"

    - name: Deploy application
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
      run: |
        ssh $EC2_HOST << 'DEPLOY_SCRIPT'
        set -e
        
        echo "🚀 Starting deployment..."
        
        # Navigate to project directory and pull latest changes
        cd /home/ubuntu/KeyNest
        git fetch origin
        git reset --hard origin/main
        git clean -fd
        
        # Make sure deploy script is executable
        chmod +x /home/ubuntu/KeyNest/backend/scripts/deploy.sh
        
        # Set DATABASE_URL environment variable for deployment
        export DATABASE_URL="${{ secrets.DATABASE_URL }}"
        
        # Run the deployment script with external database
        /home/ubuntu/KeyNest/backend/scripts/deploy.sh
        
        echo "✅ Deployment workflow completed!"
        DEPLOY_SCRIPT

    - name: Verify deployment
      run: |
        echo "🔍 Verifying deployment..."
        echo "✅ Deployment completed successfully! Services are running on EC2."
        echo "🌐 API available at: http://$EC2_HOST:8001/api/"
        echo "Note: External access requires security group configuration for port 8001"

    - name: Cleanup SSH key
      if: always()
      run: |
        rm -f ~/.ssh/keynest-prod-key.pem

    - name: Notify deployment status
      if: always()
      run: |
        if [ "${{ job.status }}" = "success" ]; then
          echo "🎉 Deployment to EC2 ($EC2_HOST) completed successfully!"
          echo "🌐 API available at: http://$EC2_HOST:8001/api/"
        else
          echo "💥 Deployment failed! Check the logs above for details."
        fi